<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Índice de Louvores</title>
    <style>
      :root {
        color-scheme: light dark;
        --bg: #0b0c0f;
        --fg: #e7e9ee;
        --muted: #8a8fa3;
        --accent: #4e8cff;
        --row: rgba(255,255,255,0.04);
      }
      html, body { margin: 0; padding: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans', 'Liberation Sans', sans-serif; }
      body { background: var(--bg); color: var(--fg); }
      header { padding: 16px 20px; position: sticky; top: 0; background: linear-gradient(180deg, rgba(0,0,0,0.6), rgba(0,0,0,0.0)); backdrop-filter: blur(6px); z-index: 5; }
      h1 { margin: 0 0 8px 0; font-size: 20px; }
      .controls { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
      input[type="search"] { flex: 1 1 280px; padding: 10px 12px; border-radius: 8px; border: 1px solid #31364a; background: #0f1220; color: var(--fg); }
      select { padding: 8px 10px; border-radius: 8px; border: 1px solid #31364a; background: #0f1220; color: var(--fg); }
      main { padding: 8px 16px 24px; }
      .count { color: var(--muted); font-size: 12px; margin-left: 4px; }
      table { width: 100%; border-collapse: collapse; }
      thead th { text-align: left; color: var(--muted); font-weight: 600; font-size: 12px; padding: 8px 10px; border-bottom: 1px solid #2a2f42; position: sticky; top: 66px; background: #0b0c0fee; backdrop-filter: blur(6px); z-index: 4; }
      tbody td { padding: 10px; border-bottom: 1px solid #171a29; }
      tbody tr:hover { background: var(--row); }
      a.btn { color: var(--accent); text-decoration: none; font-weight: 600; }
      a.btn[aria-disabled="true"] { color: #888; pointer-events: none; }
      .muted { color: var(--muted); font-size: 12px; }
      .small { font-size: 12px; }
      footer { padding: 20px; color: var(--muted); font-size: 12px; }
    </style>
  </head>
  <body>
    <header>
      <h1>Índice de Louvores <span id="count" class="count"></span></h1>
      <div class="controls">
  <input id="q" type="search" placeholder="Pesquisar por nome, ordinal, página ou arquivo" />
        <select id="sort">
          <option value="nome">Ordenar: Nome (A→Z)</option>
          <option value="ordinal">Ordenar: Ordinal (1→n)</option>
          <option value="pdf">Ordenar: Página (1→n)</option>
          <option value="pdfFile">Ordenar: Arquivo (A→Z)</option>
        </select>
      </div>
    </header>
    <main>
      <table>
        <thead>
          <tr>
            <th style="width:56px;">Abrir</th>
            <th>Nome</th>
            <th style="width:110px;">Ordinal</th>
            <th style="width:120px;">Página (PDF)</th>
            <th style="width:200px;">Arquivo</th>
          </tr>
        </thead>
        <tbody id="list"></tbody>
      </table>
    </main>
    <footer>
      Fontes: <span id="sources" class="small"></span>
    </footer>

    <script type="module">
      import louvores from './indexes/louvores-index.js';

      const leitorUrl = 'https://coletaneadigitalicm.github.io/leitor-pdf/';
      const PUBLIC_BASE_URL = 'https://jairofilho79.github.io/avulsos-cifrados/sources/';

      const listEl = document.getElementById('list');
      const qEl = document.getElementById('q');
      const sortEl = document.getElementById('sort');
      const countEl = document.getElementById('count');
      const sourcesEl = document.getElementById('sources');

      const normalizeString = (value = '') => {
        return String(value)
          .normalize('NFD')
          .replace(/[\u0300-\u036f]/g, '')
          .toUpperCase()
          .replace(/[^A-Z0-9\s]/g, '')
          .trim();
      };

      const data = louvores.map(x => {
        const nome = String(x.nome || '');
        const ordinal = (typeof x.ordinal === 'number') ? x.ordinal : null;
        const pdf = (typeof x.pdf === 'number') ? x.pdf : -1;
        const pdfFile = x.pdfFile ? String(x.pdfFile) : '';
        const pdfId = x.pdfId ? String(x.pdfId) : '';
        const pdfUrlRaw = x.pdfUrl ? String(x.pdfUrl) : (pdfFile ? PUBLIC_BASE_URL + encodeURIComponent(pdfFile) : '');
        const normNome = normalizeString(nome);
        const normOrdinal = ordinal !== null ? normalizeString(String(ordinal)) : '';
        const normPdf = pdf > 0 ? normalizeString(String(pdf)) : '';
        const normPdfFile = pdfFile ? normalizeString(pdfFile) : '';
        const normPdfId = pdfId ? normalizeString(pdfId) : '';

        return {
          nome,
          ordinal,
          pdf,
          pdfUrl: pdfUrlRaw,
          pdfFile,
          pdfId,
          normNome,
          normOrdinal,
          normPdf,
          normPdfFile,
          normPdfId,
        };
      });

      const totalCount = data.length;

      const sourcesById = new Map();
      for (const item of data) {
        const key = item.pdfId || item.pdfFile || item.pdfUrl;
        if (!key || sourcesById.has(key)) continue;
        sourcesById.set(key, {
          label: item.pdfFile || item.pdfId || 'PDF',
          url: item.pdfUrl,
        });
      }

      if (sourcesEl) {
        sourcesEl.textContent = '';
        const entries = Array.from(sourcesById.values());
        if (!entries.length) {
          sourcesEl.appendChild(document.createTextNode('—'));
        }
        entries.forEach((src, index) => {
          if (index > 0) {
            sourcesEl.appendChild(document.createTextNode(' · '));
          }
          if (src.url) {
            const link = document.createElement('a');
            link.href = src.url;
            link.textContent = src.label;
            link.target = '_blank';
            link.rel = 'noopener';
            sourcesEl.appendChild(link);
          } else {
            sourcesEl.appendChild(document.createTextNode(src.label));
          }
        });
      }

      function pageUrl(item) {
        if (!item || item.pdf <= 0 || !item.pdfUrl) return '';
        const fullUrl = `${item.pdfUrl}#page=${item.pdf}`;
        const encodedUrl = btoa(fullUrl);
        return `${leitorUrl}?url=${encodedUrl}`;
      }

      function render(items) {
        listEl.innerHTML = '';
        for (const it of items) {
          const tr = document.createElement('tr');
          const href = pageUrl(it);
          const canOpen = Boolean(href);
          const a = document.createElement('a');
          a.className = 'btn';
          a.target = '_blank';
          a.rel = 'noopener';
          a.textContent = canOpen ? 'Abrir' : '—';
          if (canOpen) {
            a.href = href;
            a.title = `Abrir "${it.nome}" na página ${it.pdf}`;
          } else {
            a.setAttribute('aria-disabled', 'true');
            a.href = 'javascript:void(0)';
            a.title = 'Página não identificada automaticamente';
          }

          const tdOpen = document.createElement('td');
          tdOpen.appendChild(a);
          const tdNome = document.createElement('td');
          tdNome.textContent = it.nome;
          const tdOrd = document.createElement('td');
          tdOrd.textContent = (it.ordinal ?? '—');
          const tdPdf = document.createElement('td');
          tdPdf.textContent = (it.pdf > 0 ? it.pdf : '—');
          const tdFile = document.createElement('td');
          tdFile.className = 'small';
          tdFile.textContent = it.pdfFile || '—';

          tr.appendChild(tdOpen);
          tr.appendChild(tdNome);
          tr.appendChild(tdOrd);
          tr.appendChild(tdPdf);
          tr.appendChild(tdFile);
          listEl.appendChild(tr);
        }
        countEl.textContent = `(${items.length} de ${totalCount} itens)`;
      }

      function applyFilters() {
        const rawQ = qEl.value || '';
        const normQ = normalizeString(rawQ);
        const key = sortEl.value;
        let items = data;
        if (normQ) {
          items = items.filter(it => (
            (it.normNome && it.normNome.includes(normQ)) ||
            (it.normOrdinal && it.normOrdinal.includes(normQ)) ||
            (it.normPdf && it.normPdf.includes(normQ)) ||
            (it.normPdfFile && it.normPdfFile.includes(normQ)) ||
            (it.normPdfId && it.normPdfId.includes(normQ))
          ));
        }
        items = [...items].sort((a, b) => {
          if (key === 'ordinal') {
            const ao = a.ordinal ?? Infinity;
            const bo = b.ordinal ?? Infinity;
            return ao - bo;
          }
          if (key === 'pdf') {
            const ap = a.pdf > 0 ? a.pdf : Infinity;
            const bp = b.pdf > 0 ? b.pdf : Infinity;
            return ap - bp;
          }
          if (key === 'pdfFile') {
            const cmp = a.pdfFile.localeCompare(b.pdfFile, 'pt-BR', { sensitivity: 'base' });
            if (cmp !== 0) return cmp;
            const ap = a.pdf > 0 ? a.pdf : Infinity;
            const bp = b.pdf > 0 ? b.pdf : Infinity;
            return ap - bp;
          }
          // default: nome
          return a.nome.localeCompare(b.nome, 'pt-BR', { sensitivity: 'base' });
        });
        render(items);
      }

      qEl.addEventListener('input', applyFilters);
      sortEl.addEventListener('change', applyFilters);

      // Inicializa
      applyFilters();

      // Atalhos: Enter no campo de busca abre o primeiro resultado
      qEl.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          const firstLink = document.querySelector('tbody a.btn[href]');
          if (firstLink) firstLink.click();
        }
      });
    </script>
  </body>
  </html>
